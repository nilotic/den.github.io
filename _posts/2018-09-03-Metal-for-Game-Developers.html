---
layout: post
title:  "Metal for Game Developers"
subtitle: "WWDC 2018"
date:   2018-09-03 20:23:33 -0000
background: '/img/posts/wwdc18.png'
---




<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Metal for Game Developers</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Metal for Game Developers</h1>
</header>
<section data-field="subtitle" class="p-summary">
WWDC 2018
</section>
<section data-field="body" class="e-content">
<section name="5744" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="1341" id="1341" class="graf graf--h3 graf--leading graf--title">Metal for Game Developers</h3><h4 name="2292" id="2292" class="graf graf--h4 graf-after--h3 graf--subtitle"><a href="https://developer.apple.com/videos/play/wwdc2018/607/" data-href="https://developer.apple.com/videos/play/wwdc2018/607/" class="markup--anchor markup--h4-anchor" rel="noopener" target="_blank">WWDC 2018</a></h4><h3 name="f960" id="f960" class="graf graf--h3 graf-after--h4">Harnessing Parallelism</h3><ul class="postList"><li name="4953" id="4953" class="graf graf--li graf-after--h3">Scalable multi-threaded encoding is key</li><li name="ba94" id="ba94" class="graf graf--li graf-after--li">Metal makes multi-threaded CPU command generation easy an fast</li><li name="3a53" id="3a53" class="graf graf--li graf-after--li">Metal automatically parallelized GPU tasks</li></ul><h3 name="f60b" id="f60b" class="graf graf--h3 graf-after--li">Multi-Threaded Rendering</h3><h4 name="6df1" id="6df1" class="graf graf--h4 graf-after--h3"><strong class="markup--strong markup--h4-strong">MTLCommandBuffer</strong></h4><figure name="1443" id="1443" class="graf graf--figure graf-after--h4"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 500px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 71.39999999999999%;"></div><img class="graf-image" data-image-id="1*2rHvCuzMTkUATQsct0eNnw.png" data-width="2766" data-height="1974" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*2rHvCuzMTkUATQsct0eNnw.png"></div></figure><figure name="050f" id="050f" class="graf graf--figure graf-after--figure graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 544px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 77.7%;"></div><img class="graf-image" data-image-id="1*3QqelrRVK7e-QPTrXEDhrQ.png" data-width="3038" data-height="2360" src="https://cdn-images-1.medium.com/max/800/1*3QqelrRVK7e-QPTrXEDhrQ.png"></div></figure></div></div></section><section name="2598" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="0f3f" id="0f3f" class="graf graf--h4 graf--leading">With MTLParallerRenderCommandEncoder</h4><figure name="a3e7" id="a3e7" class="graf graf--figure graf-after--h4"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 344px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 49.1%;"></div><img class="graf-image" data-image-id="1*tRfU9QZjcL3VJoEHTQ_xFw.png" data-width="4412" data-height="2166" src="https://cdn-images-1.medium.com/max/800/1*tRfU9QZjcL3VJoEHTQ_xFw.png"></div></figure><figure name="1cce" id="1cce" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 362px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 51.7%;"></div><img class="graf-image" data-image-id="1*aVWIFT1Ncu_ZmpH9daY5VQ.png" data-width="4518" data-height="2336" src="https://cdn-images-1.medium.com/max/800/1*aVWIFT1Ncu_ZmpH9daY5VQ.png"></div></figure><h3 name="fece" id="fece" class="graf graf--h3 graf-after--figure">GPU Parallelism</h3><figure name="1663" id="1663" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 490px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 70%;"></div><img class="graf-image" data-image-id="1*ZgiAYJly_FRiepeWvvCINw.png" data-width="3492" data-height="2446" src="https://cdn-images-1.medium.com/max/800/1*ZgiAYJly_FRiepeWvvCINw.png"></div></figure><h3 name="8b79" id="8b79" class="graf graf--h3 graf-after--figure">Taking Explicit Control</h3><ul class="postList"><li name="d7f7" id="d7f7" class="graf graf--li graf-after--h3">Metal offers more direct approaches for even less overhead</li><li name="9d82" id="9d82" class="graf graf--li graf-after--li">Disable Metal’s automatic reference counting</li><li name="dd38" id="dd38" class="graf graf--li graf-after--li">Allocate resource cheaply using heaps</li><li name="255e" id="255e" class="graf graf--li graf-after--li">Control GPU parallelism with fences and events</li></ul><h3 name="19e1" id="19e1" class="graf graf--h3 graf-after--li">Resource Heaps</h3><h4 name="ac18" id="ac18" class="graf graf--h4 graf-after--h3"><strong class="markup--strong markup--h4-strong">MLTHeap</strong></h4><ul class="postList"><li name="3973" id="3973" class="graf graf--li graf-after--h4">Control time of memory allocation</li><li name="d568" id="d568" class="graf graf--li graf-after--li">Fast reallocation and aliasing of resources</li><li name="1b12" id="1b12" class="graf graf--li graf-after--li">Cheaper resource binding</li><li name="4716" id="4716" class="graf graf--li graf-after--li">Simple API</li></ul><figure name="0431" id="0431" class="graf graf--figure graf-after--li graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 328px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 46.9%;"></div><img class="graf-image" data-image-id="1*vj2fzQ_mP0tlWW4NvaxPnQ.gif" data-width="1276" data-height="598" src="https://cdn-images-1.medium.com/max/800/1*vj2fzQ_mP0tlWW4NvaxPnQ.gif"></div></figure></div></div></section><section name="c1f3" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="fdfb" id="fdfb" class="graf graf--h4 graf--leading">Without dependency tracking</h4><figure name="f7ea" id="f7ea" class="graf graf--figure graf-after--h4"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 168px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 24.099999999999998%;"></div><img class="graf-image" data-image-id="1*xsv6Kl87MCX99LweWeDpEA.png" data-width="4040" data-height="972" src="https://cdn-images-1.medium.com/max/800/1*xsv6Kl87MCX99LweWeDpEA.png"></div></figure><h3 name="e574" id="e574" class="graf graf--h3 graf-after--figure">MTLFence and MTLEvent</h3><p name="d74b" id="d74b" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Explicit execution order</strong></p><figure name="744f" id="744f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 190px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 27.1%;"></div><img class="graf-image" data-image-id="1*hqNV4FCaJMjiZ63wYS6w6A.png" data-width="4054" data-height="1098" src="https://cdn-images-1.medium.com/max/800/1*hqNV4FCaJMjiZ63wYS6w6A.png"></div></figure><figure name="76d5" id="76d5" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 442px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 63.2%;"></div><img class="graf-image" data-image-id="1*syrD9GLint46HoaBBANjfQ.png" data-width="3870" data-height="2446" src="https://cdn-images-1.medium.com/max/800/1*syrD9GLint46HoaBBANjfQ.png"></div></figure><h3 name="e188" id="e188" class="graf graf--h3 graf-after--figure">Building GPU-Driven Pipelines</h3><ul class="postList"><li name="60ff" id="60ff" class="graf graf--li graf-after--h3">Game are moving more and more logic onto GPU<br>- Efficient processing of large datasets<br>- Growing scene graph complexity</li><li name="a8dd" id="a8dd" class="graf graf--li graf-after--li">Metal 2 enables you to move entire render loop to the GPU<br>- Argument Buffers — offload parameter management <br>- Indirect Command Buffers — offload rendering loop</li></ul><h3 name="ad09" id="ad09" class="graf graf--h3 graf-after--li">Argument Buffers</h3><figure name="38e5" id="38e5" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 299px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 42.6%;"></div><img class="graf-image" data-image-id="1*scHwtTMKGS7G2Wze7RHMYQ.png" data-width="4690" data-height="2000" src="https://cdn-images-1.medium.com/max/800/1*scHwtTMKGS7G2Wze7RHMYQ.png"></div></figure><figure name="5229" id="5229" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 326px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 46.6%;"></div><img class="graf-image" data-image-id="1*C9UE4Z-iKl-326PZQjfcEQ.png" data-width="3127" data-height="1458" src="https://cdn-images-1.medium.com/max/800/1*C9UE4Z-iKl-326PZQjfcEQ.png"></div></figure><h3 name="068a" id="068a" class="graf graf--h3 graf-after--figure">Indirect Command Buffers (ICB)</h3><ul class="postList"><li name="6ec7" id="6ec7" class="graf graf--li graf-after--h3">Allow GPU to build draw calls<br>- Massively parallel generation of commands</li><li name="dc96" id="dc96" class="graf graf--li graf-after--li">Reuse ICB in multiple frames<br>- Modify contents</li><li name="d28d" id="d28d" class="graf graf--li graf-after--li">Remove expensive CPU and GPU synchronization</li></ul><h3 name="083e" id="083e" class="graf graf--h3 graf-after--li">Game Rendering Loop</h3><p name="0078" id="0078" class="graf graf--p graf-after--h3">GPU Driven rendering loop</p><figure name="4498" id="4498" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 331px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 47.199999999999996%;"></div><img class="graf-image" data-image-id="1*XJZzsCYMqD-LKwunIr-Xbg.gif" data-width="1234" data-height="583" src="https://cdn-images-1.medium.com/max/800/1*XJZzsCYMqD-LKwunIr-Xbg.gif"></div></figure><h3 name="d96c" id="d96c" class="graf graf--h3 graf-after--figure">Encoding Drawcall Example</h3><figure name="163f" id="163f" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 339px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 48.4%;"></div><img class="graf-image" data-image-id="1*4IAIEgGoyOK7YLzrYdMVlQ.png" data-width="3798" data-height="1840" src="https://cdn-images-1.medium.com/max/800/1*4IAIEgGoyOK7YLzrYdMVlQ.png"></div></figure><h3 name="8b4c" id="8b4c" class="graf graf--h3 graf-after--figure">Executing ICB Example</h3><figure name="da8f" id="da8f" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 289px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 41.199999999999996%;"></div><img class="graf-image" data-image-id="1*u2hevwzU6l3COqkEI51W_Q.png" data-width="4070" data-height="1678" src="https://cdn-images-1.medium.com/max/800/1*u2hevwzU6l3COqkEI51W_Q.png"></div></figure><figure name="13ec" id="13ec" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 332px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 47.4%;"></div><img class="graf-image" data-image-id="1*tzxif5qs5JkpCj0JSpSvqw.gif" data-width="720" data-height="341" src="https://cdn-images-1.medium.com/max/800/1*tzxif5qs5JkpCj0JSpSvqw.gif"></div></figure><figure name="5a7b" id="5a7b" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 293px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 41.8%;"></div><img class="graf-image" data-image-id="1*NV8wfKGRF5_9_yWF3swaXA.gif" data-width="720" data-height="301" src="https://cdn-images-1.medium.com/max/800/1*NV8wfKGRF5_9_yWF3swaXA.gif"></div><figcaption class="imageCaption">Split the geometry into chunk of a few hundred triangles and analyze those chunks in a separate compute kernel</figcaption></figure><figure name="6cb9" id="6cb9" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 386px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 55.1%;"></div><img class="graf-image" data-image-id="1*JBbHgJ1xxAt-kOZSKHpMIA.gif" data-width="720" data-height="397" src="https://cdn-images-1.medium.com/max/800/1*JBbHgJ1xxAt-kOZSKHpMIA.gif"></div></figure><figure name="6eac" id="6eac" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 285px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.699999999999996%;"></div><img class="graf-image" data-image-id="1*mQiPoqVfU3mCCiMGmj9rtw.gif" data-width="720" data-height="293" src="https://cdn-images-1.medium.com/max/800/1*mQiPoqVfU3mCCiMGmj9rtw.gif"></div></figure><h3 name="c2d5" id="c2d5" class="graf graf--h3 graf-after--figure">Tile-Based Deferred Rendering (TBDR)</h3><ul class="postList"><li name="80b1" id="80b1" class="graf graf--li graf-after--h3">High performance, low power</li><li name="aa74" id="aa74" class="graf graf--li graf-after--li">Tightly integrated with Metal</li><li name="d14a" id="d14a" class="graf graf--li graf-after--li">A11 Bionic takes TBDR to the next level</li></ul><figure name="48a1" id="48a1" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 408px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 58.199999999999996%;"></div><img class="graf-image" data-image-id="1*9s8J5Zirl_SDgUYziPDaIw.png" data-width="4114" data-height="2396" src="https://cdn-images-1.medium.com/max/800/1*9s8J5Zirl_SDgUYziPDaIw.png"></div></figure><h3 name="9494" id="9494" class="graf graf--h3 graf-after--figure">Metal 2 Features on A11</h3><figure name="52d1" id="52d1" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 276px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 39.4%;"></div><img class="graf-image" data-image-id="1*6ltjyaEFWVrT_C7isKW7Lw.png" data-width="4352" data-height="1714" src="https://cdn-images-1.medium.com/max/800/1*6ltjyaEFWVrT_C7isKW7Lw.png"></div></figure><h3 name="b3d2" id="b3d2" class="graf graf--h3 graf-after--figure">Programmable Blending</h3><ul class="postList"><li name="610a" id="610a" class="graf graf--li graf-after--h3">Metal provides read-write access to pixels in tile memory<br>- Implement custom blend operations</li><li name="ef44" id="ef44" class="graf graf--li graf-after--li">Combine passes that read/write the same pixel<br>- Eliminates system memory bandwidth between passes<br>- Optimizes deferred shading</li></ul><h3 name="1f26" id="1f26" class="graf graf--h3 graf-after--li">Deferred Shading</h3><figure name="e4b0" id="e4b0" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 189px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 27%;"></div><img class="graf-image" data-image-id="1*hs5RTB_5jFiGKCT_2sOdFQ.png" data-width="4098" data-height="1108" src="https://cdn-images-1.medium.com/max/800/1*hs5RTB_5jFiGKCT_2sOdFQ.png"></div></figure><figure name="f72a" id="f72a" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*_TMLjvEyz1P2GaqlvESRfA.png" data-width="3796" data-height="2138" src="https://cdn-images-1.medium.com/max/800/1*_TMLjvEyz1P2GaqlvESRfA.png"></div></figure><h3 name="2c9d" id="2c9d" class="graf graf--h3 graf-after--figure">Imageblocks</h3><ul class="postList"><li name="36d6" id="36d6" class="graf graf--li graf-after--h3">Flexible per-pixel storage in tile memory<br>- Layout declared in shading language</li><li name="767b" id="767b" class="graf graf--li graf-after--li">Change pixel layout within a pass<br>- Merge render passes with different layouts</li></ul><h3 name="bb10" id="bb10" class="graf graf--h3 graf-after--li">Deferred Shading</h3><figure name="048e" id="048e" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 206px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 29.5%;"></div><img class="graf-image" data-image-id="1*CncbRoOtbm6A0svfv8-sfg.png" data-width="4014" data-height="1184" src="https://cdn-images-1.medium.com/max/800/1*CncbRoOtbm6A0svfv8-sfg.png"></div></figure><h3 name="bef3" id="bef3" class="graf graf--h3 graf-after--figure">Tile Shading</h3><ul class="postList"><li name="9787" id="9787" class="graf graf--li graf-after--h3">New programmable stage in the render pass<br>-Dispatch a configurable threadgroup per tile</li><li name="4ef4" id="4ef4" class="graf graf--li graf-after--li">Interleave render and compute processing<br>- Read rendering results directly from tile memory</li></ul><h3 name="b058" id="b058" class="graf graf--h3 graf-after--li">Tiled Forward Shading</h3><figure name="908a" id="908a" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*ynvizFVks4hDCrQW7qRrnQ.gif" data-width="1280" data-height="720" src="https://cdn-images-1.medium.com/max/800/1*ynvizFVks4hDCrQW7qRrnQ.gif"></div></figure><h3 name="8e34" id="8e34" class="graf graf--h3 graf-after--figure">Persistent Threadgroup Memory</h3><ul class="postList"><li name="a7f9" id="a7f9" class="graf graf--li graf-after--h3">Threadgroup memory available to render passes<br>- Available to fragment and tile shaders<br>- Buffer contents persistent for the lifetime of tile</li><li name="5f4e" id="5f4e" class="graf graf--li graf-after--li">Share data across pixels<br>- Communicate tile-scoped data between draws and tile dispatches</li></ul><h3 name="a9e3" id="a9e3" class="graf graf--h3 graf-after--li">Tile Foraward Shading</h3><figure name="0d1a" id="0d1a" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*AS89RwYFeLA4695nstXJSA.gif" data-width="1280" data-height="720" src="https://cdn-images-1.medium.com/max/800/1*AS89RwYFeLA4695nstXJSA.gif"></div></figure><h3 name="e422" id="e422" class="graf graf--h3 graf-after--figure">Deferred Shading and Multi-Layer Alpha Blending</h3><p name="a5d5" id="a5d5" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">With changing Imageblocks requires Tile Shading</strong></p><figure name="9e59" id="9e59" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 342px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 48.8%;"></div><img class="graf-image" data-image-id="1*wRCczKWAvD9jkhAls0GuYw.png" data-width="4140" data-height="2020" src="https://cdn-images-1.medium.com/max/800/1*wRCczKWAvD9jkhAls0GuYw.png"></div></figure><h3 name="8095" id="8095" class="graf graf--h3 graf-after--figure">Multi-Sample Color Coverage Control</h3><ul class="postList"><li name="9de6" id="9de6" class="graf graf--li graf-after--h3">MSAA is efficient on A-series GPUs<br>- Samples stored in tile memory for fast blending and resolves</li><li name="2194" id="2194" class="graf graf--li graf-after--li">MSAA is more efficient on A11<br>- Track unique colors in a pixel</li><li name="44cd" id="44cd" class="graf graf--li graf-after--li">Tile shading gives control over color overage<br>- Resolve in-place, in fast tile memory</li></ul><h3 name="9831" id="9831" class="graf graf--h3 graf-after--li">Multi-Sample Rendering with Transparent Particles</h3><figure name="6c81" id="6c81" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 316px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 45.2%;"></div><img class="graf-image" data-image-id="1*EvqvPjcRVNjSFLh8VTPPxg.png" data-width="4353" data-height="1968" src="https://cdn-images-1.medium.com/max/800/1*EvqvPjcRVNjSFLh8VTPPxg.png"></div><figcaption class="imageCaption">Without Color Coverage Control</figcaption></figure><figure name="61e3" id="61e3" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 335px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 47.8%;"></div><img class="graf-image" data-image-id="1*QJ-yQ8LZCmiRsTZVIQvAyg.png" data-width="4381" data-height="2094" src="https://cdn-images-1.medium.com/max/800/1*QJ-yQ8LZCmiRsTZVIQvAyg.png"></div><figcaption class="imageCaption">With Tile Shading and Color Coverage Control</figcaption></figure><figure name="406b" id="406b" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 352px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50.3%;"></div><img class="graf-image" data-image-id="1*dFjshi6UAQwGj_fLindDDw.png" data-width="4266" data-height="2144" src="https://cdn-images-1.medium.com/max/800/1*dFjshi6UAQwGj_fLindDDw.png"></div></figure><h3 name="e4a3" id="e4a3" class="graf graf--h3 graf-after--figure">Fortnite: Battle Royale</h3><p name="91b0" id="91b0" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Shipping an Unreal Engine 4 console game on iOS with Metal</strong></p><h4 name="2846" id="2846" class="graf graf--h4 graf-after--p">- Technical Chanllenges</h4><ul class="postList"><li name="8ff9" id="8ff9" class="graf graf--li graf-after--h4">one map, larger than 6km²</li><li name="c905" id="c905" class="graf graf--li graf-after--li">Time-of-day, destruction, player-built structures</li><li name="c0ea" id="c0ea" class="graf graf--li graf-after--li">100 players</li><li name="47af" id="47af" class="graf graf--li graf-after--li">50,000+ replicating actors</li><li name="e47e" id="e47e" class="graf graf--li graf-after--li">Crossplay with console and desktop players</li></ul><h3 name="4000" id="4000" class="graf graf--h3 graf-after--li">One Game, All Platforms</h3><ul class="postList"><li name="beef" id="beef" class="graf graf--li graf-after--h3">Crossplay means we are limited in out ability to scale down the game</li><li name="b008" id="b008" class="graf graf--li graf-after--li">If it affects gameplay, we can’t change it</li><li name="48d2" id="48d2" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">If a player can hide behind an object, we must render it</em></strong></li></ul><figure name="187d" id="187d" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 187px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 26.700000000000003%;"></div><img class="graf-image" data-image-id="1*GYPRJ_8fd00yq_h0hBTqmQ.png" data-width="4260" data-height="1136" src="https://cdn-images-1.medium.com/max/800/1*GYPRJ_8fd00yq_h0hBTqmQ.png"></div></figure><h3 name="e311" id="e311" class="graf graf--h3 graf-after--figure">Metal</h3><ul class="postList"><li name="9f77" id="9f77" class="graf graf--li graf-after--h3">Draw call <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">performance</em></strong> allows us to render complex scenes with 1000 of dynamic objects</li><li name="181d" id="181d" class="graf graf--li graf-after--li">Access to <strong class="markup--strong markup--li-strong">hardware features</strong>, e.g. programmable blending, allows for big wins on the GPU</li><li name="5112" id="5112" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Feature set </strong>lets us support artist authored materials, physically based rendering, dynamic lighting and shadows, GPU particle simulation</li></ul><h3 name="983d" id="983d" class="graf graf--h3 graf-after--li">Rendering Features Used on iOS</h3><ul class="postList"><li name="6241" id="6241" class="graf graf--li graf-after--h3">Movable directional light with cascaded shadow maps</li><li name="e217" id="e217" class="graf graf--li graf-after--li">Movable skylight</li><li name="b22c" id="b22c" class="graf graf--li graf-after--li">Physically based matrials</li><li name="01fb" id="01fb" class="graf graf--li graf-after--li">HDR and Tonemapping</li><li name="b87c" id="b87c" class="graf graf--li graf-after--li">GPU particle simulation</li><li name="6abb" id="6abb" class="graf graf--li graf-after--li">Artist authored materials with vertex animation</li></ul><figure name="fa74" id="fa74" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 140px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 20%;"></div><img class="graf-image" data-image-id="1*SMf-Z8dU5Ty-gLe-A5E5WQ.png" data-width="4050" data-height="810" src="https://cdn-images-1.medium.com/max/800/1*SMf-Z8dU5Ty-gLe-A5E5WQ.png"></div></figure><h3 name="9b34" id="9b34" class="graf graf--h3 graf-after--figure">Scalability</h3><ul class="postList"><li name="a0a1" id="a0a1" class="graf graf--li graf-after--h3">Scalability across platforms<br>- Minimum LOD for meshes<br>- Character LODs, animation update rates, etc.</li><li name="9bc4" id="9bc4" class="graf graf--li graf-after--li">Define 3 performance buckets, assigned devices based on performance<br>- Low (iPhone 6s, iPad Air 2, iPad min 4)<br>- Mid (iPhone 7, iPad Pro)<br>- High (iPhone 8, iPhone X, iPad Pro 2nd Gen)</li></ul><h3 name="81b6" id="81b6" class="graf graf--h3 graf-after--li">Resolution</h3><ul class="postList"><li name="41ef" id="41ef" class="graf graf--li graf-after--h3">Backbuffer resolution is what the UI renders at, determined by contentScaleFactor</li><li name="ecf6" id="ecf6" class="graf graf--li graf-after--li">3D resolution is separate, upscaled before rendering UI (adds some cost)</li><li name="7efa" id="7efa" class="graf graf--li graf-after--li">Preferred scaling backbuffer, only scaled 3D separately on iPhone 6s, iPad Air 2, and iPad (5th gen)</li><li name="d90f" id="d90f" class="graf graf--li graf-after--li">Tuned per-device</li></ul><h3 name="f457" id="f457" class="graf graf--h3 graf-after--li">Shadows</h3><p name="def9" id="def9" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Dynamic shadows have a large impact on both GPU and CPU performance</strong></p><figure name="e9c6" id="e9c6" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 236px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 33.7%;"></div><img class="graf-image" data-image-id="1*7o_tnqobOrh-SAG7yxrMNg.png" data-width="4262" data-height="1438" src="https://cdn-images-1.medium.com/max/800/1*7o_tnqobOrh-SAG7yxrMNg.png"></div></figure><h3 name="1c11" id="1c11" class="graf graf--h3 graf-after--figure">Foliage</h3><p name="024f" id="024f" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Grass and foliage scale; both density and cull distance</strong></p><figure name="b25a" id="b25a" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 235px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 33.6%;"></div><img class="graf-image" data-image-id="1*ozZ6DJCebxCKGX82oXa-dg.png" data-width="4314" data-height="1450" src="https://cdn-images-1.medium.com/max/800/1*ozZ6DJCebxCKGX82oXa-dg.png"></div></figure><h3 name="5521" id="5521" class="graf graf--h3 graf-after--figure">Memory</h3><ul class="postList"><li name="0234" id="0234" class="graf graf--li graf-after--h3">Memory doesn’t always correlate with performace<br>- iPhone 8 has less physical memory than iPhone 7+ but is faster</li><li name="8149" id="8149" class="graf graf--li graf-after--li">Low memory devices<br>- No foliage, no shadows, 16k max GPU particles, reduced pool for cosmetics, reduced texture memory pool</li><li name="f8b6" id="f8b6" class="graf graf--li graf-after--li">High memory devices<br>- Foliage, shadows, 64k max GPU particles, increased pool for cosmetics, increased texture memory pool</li></ul><h3 name="e5a0" id="e5a0" class="graf graf--h3 graf-after--li">Memory Optimizations</h3><figure name="9561" id="9561" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 337px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 48.1%;"></div><img class="graf-image" data-image-id="1*ljuhqb98wvtoHW778n7rJA.png" data-width="4166" data-height="2004" src="https://cdn-images-1.medium.com/max/800/1*ljuhqb98wvtoHW778n7rJA.png"></div></figure><h3 name="e3c8" id="e3c8" class="graf graf--h3 graf-after--figure">Framerate Targets</h3><ul class="postList"><li name="631c" id="631c" class="graf graf--li graf-after--h3">30fps at the highest visual fidelity possible</li><li name="f600" id="f600" class="graf graf--li graf-after--li">However Maxing out the CPU and GPU generates heat which causes the device to <strong class="markup--strong markup--li-strong">downclock</strong>. <br>We also want to conserve battery life<br>So we target 60fps for the environment but vsync at 30 fps</li></ul><h3 name="a7c5" id="a7c5" class="graf graf--h3 graf-after--li">Performance Tracking</h3><ul class="postList"><li name="f1ba" id="f1ba" class="graf graf--li graf-after--h3">Capture environment performance at a selection of POIs over time</li><li name="3899" id="3899" class="graf graf--li graf-after--li">Daily 100 player playtests to capture dynamic performance<br>- Key performance stats tracked<br>- Instrumented profiles gathered from one device<br>- Replays saved off for later investigation</li></ul><figure name="e345" id="e345" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 145px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 20.7%;"></div><img class="graf-image" data-image-id="1*q_xXW3ppZsEpanTVtZwQhg.png" data-width="3948" data-height="818" src="https://cdn-images-1.medium.com/max/800/1*q_xXW3ppZsEpanTVtZwQhg.png"></div></figure><h3 name="a143" id="a143" class="graf graf--h3 graf-after--figure">Threading</h3><figure name="b559" id="b559" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 249px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 35.5%;"></div><img class="graf-image" data-image-id="1*X9NYp7vp6jXkkLdBgEKFCA.png" data-width="4366" data-height="1550" src="https://cdn-images-1.medium.com/max/800/1*X9NYp7vp6jXkkLdBgEKFCA.png"></div></figure><figure name="1567" id="1567" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 280px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40%;"></div><img class="graf-image" data-image-id="1*jYEqRdRuPEmt_a6BVURndg.png" data-width="4382" data-height="1754" src="https://cdn-images-1.medium.com/max/800/1*jYEqRdRuPEmt_a6BVURndg.png"></div></figure><h3 name="d125" id="d125" class="graf graf--h3 graf-after--figure">Draw Calls</h3><ul class="postList"><li name="6a05" id="6a05" class="graf graf--li graf-after--h3">Draw calls were our main performance bottleneck</li><li name="9284" id="9284" class="graf graf--li graf-after--li">Metal’s performance really helped here, 3–4x faster than OpenGL, allowed us to ship without more aggressive work to reduce draw calls</li><li name="6f64" id="6f64" class="graf graf--li graf-after--li">Pulled in cull distance on decorative objects</li><li name="e80c" id="e80c" class="graf graf--li graf-after--li">Added HLODs to combine draw calls</li></ul><figure name="bec5" id="bec5" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 336px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 48%;"></div><img class="graf-image" data-image-id="1*JRVl6e2p467VaX6SmoMn1w.png" data-width="4410" data-height="2118" src="https://cdn-images-1.medium.com/max/800/1*JRVl6e2p467VaX6SmoMn1w.png"></div></figure><h3 name="192e" id="192e" class="graf graf--h3 graf-after--figure">Hierarchical LOD</h3><ul class="postList"><li name="99bb" id="99bb" class="graf graf--li graf-after--h3">Combine draw calls for a group of meshes</li><li name="8a85" id="8a85" class="graf graf--li graf-after--li">Allow us to render the entire map while skydiving</li><li name="ccb3" id="ccb3" class="graf graf--li graf-after--li">Even on the ground, POIs are visible from up to 2km away</li><li name="83f1" id="83f1" class="graf graf--li graf-after--li">Added mid-range HLODs to further reduce draw calls in complex scenes like Tilted Towers</li></ul><h3 name="80b7" id="80b7" class="graf graf--h3 graf-after--li">Pipeline State Objects</h3><ul class="postList"><li name="086e" id="086e" class="graf graf--li graf-after--h3">Minimize how many are created at runtime to prevent hitching</li><li name="1e7a" id="1e7a" class="graf graf--li graf-after--li">Follow best practives<br>- Compile functions offline<br>- Build library offline<br>- Group functions into a single library you can ship with your game</li><li name="76b1" id="76b1" class="graf graf--li graf-after--li">Ideally create all of the PSOs you need at load time</li><li name="cf48" id="cf48" class="graf graf--li graf-after--li">What if the set of PSOs you might need is large?<br>- Artist authored shaders x Lighting scenarios x RT formats x MSAA x Stencil state (e.g. LOD dithering) x Input layout x Scalability level x and more</li><li name="2d1c" id="2d1c" class="graf graf--li graf-after--li">Minimize permutations where you can!<br>- Sometimes a dynamic branch is fine</li><li name="2f1b" id="2f1b" class="graf graf--li graf-after--li">Identity the most common subset you are likely to need and create those at load</li><li name="38d2" id="38d2" class="graf graf--li graf-after--li">We use automation to run the game and gather PSOs used by device across the map, load cosmetics, fire weapons, etc.</li><li name="112b" id="112b" class="graf graf--li graf-after--li">We also store PSOs created during daily playtests</li><li name="3452" id="3452" class="graf graf--li graf-after--li">Not perfect, but…<br>- Number of PSOs created during gameplay is in the single digits on average<br>- We only create a small subset of the permutation matrix on load</li></ul><h3 name="4d07" id="4d07" class="graf graf--h3 graf-after--li">Resource Allocation</h3><ul class="postList"><li name="3734" id="3734" class="graf graf--li graf-after--h3">Creating resources on the fly can hitch due to streaming or creation of dynamic objects</li><li name="3b43" id="3b43" class="graf graf--li graf-after--li">Treat resource allocation like memory allocation and use the same strategies to minimize “malloc” and “free”</li><li name="0315" id="0315" class="graf graf--li graf-after--li">We use a binned allocation strategy for smaller allocations</li></ul><h3 name="cd13" id="cd13" class="graf graf--h3 graf-after--li">Programmable Blending</h3><ul class="postList"><li name="9a2b" id="9a2b" class="graf graf--li graf-after--h3">Optimization to reduce the number of resolves and restores for features that need to read the depth buffer, e.g. decals and soft particle blending</li><li name="cdaf" id="cdaf" class="graf graf--li graf-after--li">During forward pass, write linear depth to alpha channel (we render to FP16 render target)</li><li name="2228" id="2228" class="graf graf--li graf-after--li">During decal and translucent passes, if needed, read [[ color(0) ]] .a as linear depth</li><li name="6345" id="6345" class="graf graf--li graf-after--li">MSAA resolve happens before postprocessing and tonemapping</li><li name="9a9e" id="9a9e" class="graf graf--li graf-after--li">Bilinear filtering of HDR values can lead to very aliased edges, e.g. dark ceiling in shadow against a bright sky</li></ul><figure name="9d51" id="9d51" class="graf graf--figure graf-after--li graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 157px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 22.5%;"></div><img class="graf-image" data-image-id="1*-CBO-eJGDihAhWL61_gK8Q.png" data-width="3608" data-height="810" src="https://cdn-images-1.medium.com/max/800/1*-CBO-eJGDihAhWL61_gK8Q.png"></div></figure></div></div></section><section name="15b3" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="6cbb" id="6cbb" class="graf graf--h4 graf--leading">Solution</h4><p name="ad81" id="ad81" class="graf graf--p graf-after--h4">Use programmable blending for the pre- tonemap pass to avoid resolving the MSAA color buffer to memory!</p><ul class="postList"><li name="fc2f" id="fc2f" class="graf graf--li graf-after--p">Pre-tonemap before resolve</li><li name="1a4c" id="1a4c" class="graf graf--li graf-after--li">Perform the normal MSAA resolve</li><li name="4de2" id="4de2" class="graf graf--li graf-after--li">The first postprocessing pass reverses the “pre-tonemap”</li></ul><figure name="8336" id="8336" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 195px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 27.800000000000004%;"></div><img class="graf-image" data-image-id="1*rau7DrPkQDQBPgg_g5WE1w.png" data-width="3558" data-height="990" src="https://cdn-images-1.medium.com/max/800/1*rau7DrPkQDQBPgg_g5WE1w.png"></div></figure><h3 name="f46c" id="f46c" class="graf graf--h3 graf-after--figure">Parallel Rendering</h3><ul class="postList"><li name="65b9" id="65b9" class="graf graf--li graf-after--h3">On macOS we generate command buffers in parallel<br>- Not using parallel command encoders right now, separate command buffers easier to integrate in existing parallel rendering architecture<br>- Parallel command encoders would be needed on iOS</li><li name="fb3b" id="fb3b" class="graf graf--li graf-after--li">Experiment with parallel rendering on iOS<br>- For example, rendering thread on fast core versus four encoding threads on efficient cores</li></ul><h3 name="caa1" id="caa1" class="graf graf--h3 graf-after--li">Metal Heaps</h3><ul class="postList"><li name="aced" id="aced" class="graf graf--li graf-after--h3">Use MTLHeap instead of buffer sub-allocation</li><li name="2f3c" id="2f3c" class="graf graf--li graf-after--li">Would also reduce hitches due to texture streaming</li><li name="dca1" id="dca1" class="graf graf--li graf-after--li graf--trailing">Requires precise fences, particularly which stages read which resources<br>- Full barriers between passes underutilize the GPU<br>- Requires some rework of our rendering architecture to make this<br>bulletproof</li></ul></div></div></section>
</section>