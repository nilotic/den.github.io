---
layout: post
title:  "Metal Game Performance Optimization"
subtitle: "WWDC 2018"
date:   2018-09-04 20:23:33 -0000
background: '/img/posts/wwdc18.png'
---





<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Metal Game Performance Optimization</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Metal Game Performance Optimization</h1>
</header>
<section data-field="subtitle" class="p-summary">
WWDC 2018
</section>
<section data-field="body" class="e-content">
<section name="cc06" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="a80c" id="a80c" class="graf graf--h3 graf--leading graf--title">Metal Game Performance Optimization</h3><h4 name="f824" id="f824" class="graf graf--h4 graf-after--h3 graf--subtitle"><a href="https://developer.apple.com/videos/play/wwdc2018/612/" data-href="https://developer.apple.com/videos/play/wwdc2018/612/" class="markup--anchor markup--h4-anchor" rel="noopener" target="_blank">WWDC 2018</a></h4><h3 name="bea0" id="bea0" class="graf graf--h3 graf-after--h4">Game Performance Template</h3><figure name="c3ce" id="c3ce" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 282px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.300000000000004%;"></div><img class="graf-image" data-image-id="1*dw3U8_5DpjHSRScCw3zAvQ.png" data-width="4440" data-height="1788" src="https://cdn-images-1.medium.com/max/800/1*dw3U8_5DpjHSRScCw3zAvQ.png"></div></figure><figure name="8889" id="8889" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 453px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 64.8%;"></div><img class="graf-image" data-image-id="1*mszqyfTk2AAhlhnoW1y0hg.png" data-width="2804" data-height="1816" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*mszqyfTk2AAhlhnoW1y0hg.png"></div></figure><figure name="a199" id="a199" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*dgtKBqSFRKTMEN37M-_fHQ.png" data-width="4362" data-height="2454" src="https://cdn-images-1.medium.com/max/800/1*dgtKBqSFRKTMEN37M-_fHQ.png"></div></figure><h3 name="c1ca" id="c1ca" class="graf graf--h3 graf-after--figure">Thread State View (new)</h3><figure name="ad9b" id="ad9b" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 320px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 45.7%;"></div><img class="graf-image" data-image-id="1*uP36W8xSD_ukUbzc1CBfyg.png" data-width="4526" data-height="2068" src="https://cdn-images-1.medium.com/max/800/1*uP36W8xSD_ukUbzc1CBfyg.png"></div></figure><h3 name="eea3" id="eea3" class="graf graf--h3 graf-after--figure">Frame Pacing</h3><figure name="c8d6" id="c8d6" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 500px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 71.39999999999999%;"></div><img class="graf-image" data-image-id="1*qSHX41a5XcSatbYvn-8_KQ.gif" data-width="1009" data-height="720" src="https://cdn-images-1.medium.com/max/800/1*qSHX41a5XcSatbYvn-8_KQ.gif"></div></figure><h3 name="43b6" id="43b6" class="graf graf--h3 graf-after--figure">Micro Stuttering</h3><p name="3ebb" id="3ebb" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Inconsistent frame rate</strong></p><ul class="postList"><li name="527e" id="527e" class="graf graf--li graf-after--p">Frame time higher than display refresh interval</li><li name="208c" id="208c" class="graf graf--li graf-after--li">Game logic timing errors</li></ul><figure name="183a" id="183a" class="graf graf--figure graf-after--li graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 286px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.9%;"></div><img class="graf-image" data-image-id="1*NKW7AnVfuZXYXHIPz2yPOA.png" data-width="4927" data-height="2015" src="https://cdn-images-1.medium.com/max/800/1*NKW7AnVfuZXYXHIPz2yPOA.png"></div></figure></div></div></section><section name="52e7" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="774d" id="774d" class="graf graf--h4 graf--leading">Problem</h4><ul class="postList"><li name="81b5" id="81b5" class="graf graf--li graf-after--h4">Do not use sleep() to pace frames!</li></ul><figure name="f75c" id="f75c" class="graf graf--figure graf-after--li graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 299px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 42.8%;"></div><img class="graf-image" data-image-id="1*yMQ3QjVbNSyCar3z1K5nHw.png" data-width="4630" data-height="1980" src="https://cdn-images-1.medium.com/max/800/1*yMQ3QjVbNSyCar3z1K5nHw.png"></div></figure></div></div></section><section name="4b15" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b498" id="b498" class="graf graf--h3 graf--leading">Best Practice</h3><ul class="postList"><li name="c93f" id="c93f" class="graf graf--li graf-after--h3">Target explicit frame rate</li><li name="0240" id="0240" class="graf graf--li graf-after--li">Use the following APIs (iOS 10.3 +)<br><strong class="markup--strong markup--li-strong">- </strong><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">MTLDrawable addPresentedHandler</strong></code><br><strong class="markup--strong markup--li-strong">- </strong><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">MTLCommandBuffer presentDrawable afterMinimumDuration</strong></code><strong class="markup--strong markup--li-strong"><br>- </strong><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">MTLCommandBuffer presentDrawable atTime</strong></code></li></ul><figure name="2cca" id="2cca" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 205px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 29.299999999999997%;"></div><img class="graf-image" data-image-id="1*ndKY1v69qoB50d5hqI7Xww.png" data-width="4408" data-height="1290" src="https://cdn-images-1.medium.com/max/800/1*ndKY1v69qoB50d5hqI7Xww.png"></div></figure><figure name="8a7b" id="8a7b" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 302px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 43.1%;"></div><img class="graf-image" data-image-id="1*SvORlAHpS88iGLEo8T_stw.png" data-width="4566" data-height="1970" src="https://cdn-images-1.medium.com/max/800/1*SvORlAHpS88iGLEo8T_stw.png"></div></figure><h3 name="9adc" id="9adc" class="graf graf--h3 graf-after--figure">Thread Stalling</h3><p name="17ff" id="17ff" class="graf graf--p graf-after--h3">Render thread gets preempted due to low priority</p><ul class="postList"><li name="3985" id="3985" class="graf graf--li graf-after--p">Priority decay</li><li name="5062" id="5062" class="graf graf--li graf-after--li">Priority inversion</li></ul><figure name="021b" id="021b" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 270px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 38.6%;"></div><img class="graf-image" data-image-id="1*gsquXINKcSU11xyKebCV4w.png" data-width="4556" data-height="1758" src="https://cdn-images-1.medium.com/max/800/1*gsquXINKcSU11xyKebCV4w.png"></div></figure><figure name="f7ff" id="f7ff" class="graf graf--figure graf-after--figure graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 393px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.10000000000001%;"></div><img class="graf-image" data-image-id="1*a4NxXv_JSG0t8CLieOYWtw.gif" data-width="1082" data-height="607" src="https://cdn-images-1.medium.com/max/800/1*a4NxXv_JSG0t8CLieOYWtw.gif"></div></figure></div></div></section><section name="c9b4" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="576e" id="576e" class="graf graf--h3 graf--leading">Best Practice</h3><p name="bee2" id="bee2" class="graf graf--p graf-after--h3">Configure the render thread</p><ul class="postList"><li name="22d4" id="22d4" class="graf graf--li graf-after--p">Priority 45</li><li name="84dd" id="84dd" class="graf graf--li graf-after--li">Opt out of Quality of Service</li></ul><figure name="cf19" id="cf19" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 275px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 39.300000000000004%;"></div><img class="graf-image" data-image-id="1*ZRRvX9FUeMXjIH31X91W4A.png" data-width="4382" data-height="1724" src="https://cdn-images-1.medium.com/max/800/1*ZRRvX9FUeMXjIH31X91W4A.png"></div></figure><figure name="758d" id="758d" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 202px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 28.9%;"></div><img class="graf-image" data-image-id="1*k_Cm2N9d5RnQC7YH2kCG6w.png" data-width="4414" data-height="1274" src="https://cdn-images-1.medium.com/max/800/1*k_Cm2N9d5RnQC7YH2kCG6w.png"></div></figure><h3 name="6529" id="6529" class="graf graf--h3 graf-after--figure">Thermal Throttling</h3><p name="ce43" id="ce43" class="graf graf--p graf-after--h3">Impact on system performace</p><ul class="postList"><li name="62d5" id="62d5" class="graf graf--li graf-after--p">High device temperature</li><li name="08e0" id="08e0" class="graf graf--li graf-after--li graf--trailing">Low power mode enabled</li></ul></div></div></section><section name="0cfe" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="047a" id="047a" class="graf graf--h3 graf--leading">Best Practice</h3><ul class="postList"><li name="f385" id="f385" class="graf graf--li graf-after--h3">Adjust the workload to the system state</li><li name="f13e" id="f13e" class="graf graf--li graf-after--li">Use the following APIs<br><strong class="markup--strong markup--li-strong">- iOS 11.0+ : </strong><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">NSProcessInfo thermalState</strong></code><strong class="markup--strong markup--li-strong"><br>- iOS 10.3+ : </strong><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">MTLCommandBuffer GPUStartTime/ GPUEndTime</strong></code><strong class="markup--strong markup--li-strong"><br>- iOS 9.0+ : </strong><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">NSProcessInfo lowPowerModeEnabled</strong></code></li></ul><figure name="9adf" id="9adf" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 426px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 60.9%;"></div><img class="graf-image" data-image-id="1*CtNvFoSEBTBNMUOZfOLj9g.png" data-width="3452" data-height="2102" src="https://cdn-images-1.medium.com/max/800/1*CtNvFoSEBTBNMUOZfOLj9g.png"></div></figure><h3 name="0355" id="0355" class="graf graf--h3 graf-after--figure">Adjust the Workload</h3><ul class="postList"><li name="1326" id="1326" class="graf graf--li graf-after--h3">Target sustainable framerate</li><li name="490c" id="490c" class="graf graf--li graf-after--li">Reduce the resolution</li><li name="ea14" id="ea14" class="graf graf--li graf-after--li">Simplify the shadow maps</li><li name="baef" id="baef" class="graf graf--li graf-after--li">Use smaller textures</li><li name="0838" id="0838" class="graf graf--li graf-after--li">Decrease the level of detail (LOD) for geometry</li><li name="78ab" id="78ab" class="graf graf--li graf-after--li">Simplify post-processing and effects</li></ul><h3 name="644f" id="644f" class="graf graf--h3 graf-after--li">Wasted GPU Time</h3><p name="641a" id="641a" class="graf graf--p graf-after--h3">Waste of power and GPU budget</p><ul class="postList"><li name="9ad1" id="9ad1" class="graf graf--li graf-after--p">Large resources</li><li name="a584" id="a584" class="graf graf--li graf-after--li graf--trailing">Unused GPU work</li></ul></div></div></section><section name="df48" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="12ec" id="12ec" class="graf graf--h3 graf--leading">Best Practice</h3><p name="b4bf" id="b4bf" class="graf graf--p graf-after--h3">Profile the GPU</p><ul class="postList"><li name="87b1" id="87b1" class="graf graf--li graf-after--p">Understand the cost of every rendering feature</li><li name="7f3e" id="7f3e" class="graf graf--li graf-after--li">Remove excessive work</li></ul><h3 name="91e4" id="91e4" class="graf graf--h3 graf-after--li">Metal System Trace</h3><ul class="postList"><li name="cba7" id="cba7" class="graf graf--li graf-after--h3">Accurate timing for Vertex, Fragment, and Compute work</li><li name="9879" id="9879" class="graf graf--li graf-after--li">Ideal to measure GPU budget</li></ul><figure name="44ab" id="44ab" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 285px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40.8%;"></div><img class="graf-image" data-image-id="1*Y2PceoEGtCQ9YOws_62V7Q.png" data-width="3322" data-height="1354" src="https://cdn-images-1.medium.com/max/800/1*Y2PceoEGtCQ9YOws_62V7Q.png"></div></figure><h3 name="141b" id="141b" class="graf graf--h3 graf-after--figure">Dependency Viewer</h3><figure name="619b" id="619b" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 356px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50.8%;"></div><img class="graf-image" data-image-id="1*JUGdN8EBgWCKSd-Ifhagmg.png" data-width="3936" data-height="2000" src="https://cdn-images-1.medium.com/max/800/1*JUGdN8EBgWCKSd-Ifhagmg.png"></div></figure><figure name="c48a" id="c48a" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 495px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 70.8%;"></div><img class="graf-image" data-image-id="1*Bor-usHTB-seiLWvULTWUQ.png" data-width="2826" data-height="2000" src="https://cdn-images-1.medium.com/max/800/1*Bor-usHTB-seiLWvULTWUQ.png"></div></figure><figure name="29c6" id="29c6" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 352px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50.3%;"></div><img class="graf-image" data-image-id="1*p0kic5EFqWFCzWh-Li9vSw.gif" data-width="1000" data-height="503" src="https://cdn-images-1.medium.com/max/800/1*p0kic5EFqWFCzWh-Li9vSw.gif"></div></figure><figure name="1e50" id="1e50" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 350px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50%;"></div><img class="graf-image" data-image-id="1*dZU_lOgeKagTXwbL_sOJCg.gif" data-width="1000" data-height="500" src="https://cdn-images-1.medium.com/max/800/1*dZU_lOgeKagTXwbL_sOJCg.gif"></div></figure><h3 name="33c4" id="33c4" class="graf graf--h3 graf-after--figure">Finding Hidden Complexity</h3><figure name="a1d4" id="a1d4" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 508px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 72.6%;"></div><img class="graf-image" data-image-id="1*NAABHCc3iOsfyNAkxBR1Xg.png" data-width="3403" data-height="2469" src="https://cdn-images-1.medium.com/max/800/1*NAABHCc3iOsfyNAkxBR1Xg.png"></div></figure><figure name="1854" id="1854" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 351px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50.1%;"></div><img class="graf-image" data-image-id="1*GP6nF6f3M7-n8lPFBOU4qg.gif" data-width="1000" data-height="501" src="https://cdn-images-1.medium.com/max/800/1*GP6nF6f3M7-n8lPFBOU4qg.gif"></div></figure><h3 name="bcd2" id="bcd2" class="graf graf--h3 graf-after--figure">Take-Away</h3><ul class="postList"><li name="069a" id="069a" class="graf graf--li graf-after--h3">Profile early and often</li><li name="738f" id="738f" class="graf graf--li graf-after--li">Target a consistent frame rate</li><li name="58f0" id="58f0" class="graf graf--li graf-after--li">Set the correct thread prriorites</li><li name="971f" id="971f" class="graf graf--li graf-after--li">Adapt to system load and thermals</li><li name="bff4" id="bff4" class="graf graf--li graf-after--li graf--trailing">Don’t submit unnecessary work to the GPU</li></ul></div></div></section>
</section>